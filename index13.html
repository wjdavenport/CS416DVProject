<!DOCTYPE html>
<html>
<head>
  <title>Volcano Map Visualization</title>
  <style>
    .volcano-circle {
      fill: orange;
      stroke: #fff;
      stroke-width: 0.1;
    }

    .annotation-text {
      font-family: Arial, sans-serif;
      font-size: 18px;
      fill: blue;
      text-anchor: middle;
      opacity: 0.7;
    }
  </style>
</head>
<body>
  <svg id="map" width="800" height="600"></svg>

  <script src="https://d3js.org/d3.v6.min.js"></script>
  <script>
    // Load world map GeoJSON data
    d3.json("countries.geojson").then(function(worldData) {
      const projection = d3.geoMercator()
        .fitSize([800, 600], worldData);

      const pathGenerator = d3.geoPath().projection(projection);

      d3.select("#map")
        .selectAll("path")
        .data(worldData.features)
        .enter()
        .append("path")
        .attr("d", pathGenerator);

      d3.csv("GVP_Volcano_List_Holocene1.csv").then(function(volcanoData) {
        volcanoData.forEach(function(d) {
          d.latitude = +d.Latitude;
          d.longitude = +d.Longitude;
          if (d["Last Known Eruption"] === "Unknown") {
            d.eruptionYear = new Date("-99999");
          } else {
            const eruptionYear = d["Last Known Eruption"];
            if (eruptionYear.endsWith("BCE")) {
              const year = parseInt(eruptionYear.split(" ")[0]);
              d.eruptionYear = new Date(-year, 0);
            } else {
              const year = parseInt(eruptionYear);
              d.eruptionYear = new Date(year, 0);
            }
          }
        });

        volcanoData.sort((a, b) => a.eruptionYear - b.eruptionYear);

        const animationSpeed = 20;
        volcanoData.forEach(function(d, i) {
          d.delay = i * animationSpeed;
        });

        d3.select("#map")
          .selectAll(".initial-dots")
          .data(volcanoData)
          .enter()
          .append("circle")
          .attr("class", "volcano-circle initial-dots")
          .attr("cx", function(d) {
            const cx = projection([d.longitude, d.latitude])[0];
            return cx;
          })
          .attr("cy", function(d) {
            const cy = projection([d.longitude, d.latitude])[1];
            return cy;
          })
          .attr("r", 1)
          .append("title") // append a title to each circle
          .text(d => d["Tectonic Setting"]); // set the title text to the Tectonic Setting

        const svg = d3.select("#map");
        const annotationDelay = 20;

        svg.append("text")
          .attr("class", "annotation-text")
          .attr("x", 50)
          .attr("y", 30)
          .style("opacity", 0)
          .style("font-weight", "bold")
          .style("font-size", "18px");

        setTimeout(function() {
          d3.selectAll(".initial-dots")
            .transition()
            .delay(d => d.delay)
            .duration(animationSpeed)
            .attr("class", "volcano-circle")
            .attr("r", d => d["Last Known Eruption"] !== "Unknown" ? 3 : 1)
            .style("fill", d => d["Last Known Eruption"] !== "Unknown" ? "red" : "orange")
            .on("end", function(d, i) {
              if (d["Last Known Eruption"] !== "Unknown") {
                const eruptionYear = d.eruptionYear.getFullYear();
                svg.select(".annotation-text") // select the existing text element
                  .text(eruptionYear) // update its text
                  .style("opacity", 0) // start with 0 opacity
                  .transition()
                  .delay(annotationDelay)
                  .style("opacity", 1); // make it fully visible
              }
            });
        }, annotationDelay);

      }).catch(function(error) {
        console.log("Error loading volcano data: " + error);
      });
    }).catch(function(error) {
      console.log("Error loading map data: " + error);
    });
  </script>
</body>
</html>
